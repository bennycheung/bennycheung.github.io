<!-- Series Navigation -->
{% if page.series %}

{% comment %}
  Support both old format (string) and new format (array of objects)
  Old: series: "Series Name" / series_order: 1
  New: series: [{name: "Series A", order: 1}, {name: "Series B", order: 2}]
{% endcomment %}

{% if page.series.first.name %}
  {% comment %} New multi-series format {% endcomment %}
  {% for current_series in page.series %}
    {% assign series_name = current_series.name %}
    {% assign current_order = current_series.order %}

    {% comment %} Collect all posts in this series with their order {% endcomment %}
    {% assign series_posts_unsorted = "" | split: "" %}
    {% assign series_orders = "" | split: "" %}
    {% for post in site.posts %}
      {% assign this_order = nil %}
      {% if post.series.first.name %}
        {% for ps in post.series %}
          {% if ps.name == series_name %}
            {% assign this_order = ps.order %}
            {% break %}
          {% endif %}
        {% endfor %}
      {% elsif post.series == series_name %}
        {% assign this_order = post.series_order %}
      {% endif %}
      {% if this_order %}
        {% assign series_posts_unsorted = series_posts_unsorted | push: post %}
        {% assign series_orders = series_orders | push: this_order %}
      {% endif %}
    {% endfor %}

    {% comment %} Manual sort: iterate from 1 to max_order and pick posts in order {% endcomment %}
    {% assign series_posts = "" | split: "" %}
    {% for order_num in (1..20) %}
      {% for i in (0..series_posts_unsorted.size) %}
        {% if series_orders[i] == order_num %}
          {% assign series_posts = series_posts | push: series_posts_unsorted[i] %}
        {% endif %}
      {% endfor %}
    {% endfor %}

    {% if series_posts.size > 1 %}
    <div class="series-nav">
      <div class="series-header">
        <span class="series-label"><i class="fa fa-bookmark"></i> Series</span>
        <h4 class="series-title">{{ series_name }}</h4>
        <span class="series-progress">Part {{ current_order }} of {{ series_posts.size }}</span>
      </div>
      <div class="series-posts">
        {% for post in series_posts %}
          {% comment %} Get this post's order in current series {% endcomment %}
          {% if post.series.first.name %}
            {% for ps in post.series %}
              {% if ps.name == series_name %}
                {% assign post_order = ps.order %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% else %}
            {% assign post_order = post.series_order %}
          {% endif %}
        <a href="{{ post.url }}" class="series-post {% if post.url == page.url %}current{% endif %}">
          <span class="series-post-number">{{ post_order }}</span>
          <span class="series-post-title">{{ post.title }}</span>
          {% if post.url == page.url %}<i class="fa fa-arrow-left"></i>{% endif %}
        </a>
        {% endfor %}
      </div>
      <div class="series-nav-buttons">
        {% for post in series_posts %}
          {% if post.series.first.name %}
            {% for ps in post.series %}
              {% if ps.name == series_name %}
                {% assign post_order = ps.order %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% else %}
            {% assign post_order = post.series_order %}
          {% endif %}
          {% assign prev_order = current_order | minus: 1 %}
          {% assign next_order = current_order | plus: 1 %}
          {% if post_order == prev_order %}
            <a href="{{ post.url }}" class="series-btn prev-btn"><i class="fa fa-chevron-left"></i> Previous Part</a>
          {% endif %}
          {% if post_order == next_order %}
            <a href="{{ post.url }}" class="series-btn next-btn">Next Part <i class="fa fa-chevron-right"></i></a>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}
  {% endfor %}

{% else %}
  {% comment %} Old single-series format {% endcomment %}
  {% assign series_posts_unsorted = "" | split: "" %}
  {% assign series_orders = "" | split: "" %}
  {% for post in site.posts %}
    {% assign this_order = nil %}
    {% if post.series.first.name %}
      {% for ps in post.series %}
        {% if ps.name == page.series %}
          {% assign this_order = ps.order %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% elsif post.series == page.series %}
      {% assign this_order = post.series_order %}
    {% endif %}
    {% if this_order %}
      {% assign series_posts_unsorted = series_posts_unsorted | push: post %}
      {% assign series_orders = series_orders | push: this_order %}
    {% endif %}
  {% endfor %}

  {% comment %} Manual sort: iterate from 1 to max_order and pick posts in order {% endcomment %}
  {% assign series_posts = "" | split: "" %}
  {% for order_num in (1..20) %}
    {% for i in (0..series_posts_unsorted.size) %}
      {% if series_orders[i] == order_num %}
        {% assign series_posts = series_posts | push: series_posts_unsorted[i] %}
      {% endif %}
    {% endfor %}
  {% endfor %}

  {% if series_posts.size > 1 %}
  <div class="series-nav">
    <div class="series-header">
      <span class="series-label"><i class="fa fa-bookmark"></i> Series</span>
      <h4 class="series-title">{{ page.series }}</h4>
      <span class="series-progress">Part {{ page.series_order }} of {{ series_posts.size }}</span>
    </div>
    <div class="series-posts">
      {% for post in series_posts %}
        {% if post.series.first.name %}
          {% for ps in post.series %}
            {% if ps.name == page.series %}
              {% assign post_order = ps.order %}
              {% break %}
            {% endif %}
          {% endfor %}
        {% else %}
          {% assign post_order = post.series_order %}
        {% endif %}
      <a href="{{ post.url }}" class="series-post {% if post.url == page.url %}current{% endif %}">
        <span class="series-post-number">{{ post_order }}</span>
        <span class="series-post-title">{{ post.title }}</span>
        {% if post.url == page.url %}<i class="fa fa-arrow-left"></i>{% endif %}
      </a>
      {% endfor %}
    </div>
    <div class="series-nav-buttons">
      {% for post in series_posts %}
        {% if post.series.first.name %}
          {% for ps in post.series %}
            {% if ps.name == page.series %}
              {% assign post_order = ps.order %}
              {% break %}
            {% endif %}
          {% endfor %}
        {% else %}
          {% assign post_order = post.series_order %}
        {% endif %}
        {% if post_order == page.series_order | minus: 1 %}
          <a href="{{ post.url }}" class="series-btn prev-btn"><i class="fa fa-chevron-left"></i> Previous Part</a>
        {% endif %}
        {% if post_order == page.series_order | plus: 1 %}
          <a href="{{ post.url }}" class="series-btn next-btn">Next Part <i class="fa fa-chevron-right"></i></a>
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}
{% endif %}

{% endif %}
